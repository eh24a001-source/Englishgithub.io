<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ëã±ÂçòË™û„ÇØ„Ç§„Ç∫ - Supabase Ranking</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; text-align: center; padding-top: 50px; background-color: #f0f2f5; color: #2f3640; }
        .container { background: white; max-width: 500px; margin: auto; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: relative; overflow: hidden; min-height: 480px; }
        #timer-container { width: 100%; height: 8px; background-color: #eee; position: absolute; top: 0; left: 0; display: none; }
        #timer-bar { width: 100%; height: 100%; background-color: #4cd137; transition: width 0.05s linear; }
        #name-screen input { padding: 12px; font-size: 18px; border-radius: 8px; border: 2px solid #ddd; width: 80%; margin-bottom: 20px; }
        #word { font-size: 48px; font-weight: bold; margin: 20px 0; }
        .choices-container { display: grid; grid-template-columns: 1 white; gap: 12px; }
        .choice-btn { font-size: 18px; padding: 15px; background: #fff; border: 2px solid #487eb0; border-radius: 12px; cursor: pointer; color: #487eb0; font-weight: bold; }
        .choice-btn:disabled { opacity: 0.6; }
        .score-display { font-size: 64px; font-weight: bold; color: #e84118; margin: 10px 0; }
        .rank-display { font-size: 24px; color: #2f3640; margin-bottom: 20px; background: #fff3cd; padding: 10px; border-radius: 10px; display: none; }
        .btn-primary { padding: 15px 40px; font-size: 18px; background: #487eb0; color: white; border: none; border-radius: 50px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div id="timer-container"><div id="timer-bar"></div></div>

    <div id="name-screen">
        <h2>SUPABASE QUIZ</h2>
        <input type="text" id="user-name" placeholder="„Éã„ÉÉ„ÇØ„Éç„Éº„É†" maxlength="15">
        <br>
        <button class="btn-primary" onclick="confirmName()">„ÇØ„Ç§„Ç∫ÈñãÂßã</button>
    </div>

    <div id="quiz-area" style="display:none;">
        <div id="progress">Á¨¨ 1 / 10 Âïè</div>
        <div id="word">Word</div>
        <div id="choices" class="choices-container"></div>
        <div id="feedback" style="height:30px; margin-top:20px; font-weight:bold;"></div>
    </div>

    <div id="result-area" style="display:none;">
    <div style="font-size:20px;">TOTAL SCORE</div>
    <div id="final-points" class="score-display">0</div>
    <div id="rank-container" class="rank-display">‰ªäÊó•„ÅÆÈ†Ü‰Ωç: <span id="rank-val">-</span> ‰Ωç</div>
    
    <div style="margin-top: 20px; text-align: left; background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #ddd;">
        <strong style="display:block; margin-bottom:10px; text-align:center;">üèÜ Êú¨Êó•„ÅÆTOP 5</strong>
        <table style="width: 100%; border-collapse: collapse; font-size: 14px;" id="leaderboard">
            </table>
    </div>
    <button class="btn-primary" style="margin-top:20px;" onclick="location.reload()">RETRY</button>
    <p id="msg" style="font-size:12px; color:gray; margin-top:10px;"></p>
</div>
</div>

<script>
    // --- SupabaseË®≠ÂÆö„Ç®„É™„Ç¢ ---
    const SUPABASE_URL = "https://lfnakzmimvwxsjplpekf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxmbmFrem1pbXZ3eHNqcGxwZWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxOTE0MjAsImV4cCI6MjA4Mzc2NzQyMH0.wClqc-uVjb_SdC10BVAEo_9wIUv6E2apNzD_Oy7bfdk";
    
    // „Éñ„É©„Ç¶„Ç∂Áî®„ÅÆÂàùÊúüÂåñÊñπÊ≥ï„Å´‰øÆÊ≠£
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- „ÇØ„Ç§„Ç∫Ë®≠ÂÆö ---
    const MAX_QUESTIONS = 10;
    const TIME_LIMIT_MS = 10000;
    let wordList = [], currentIndex = 0, correctCount = 0, totalScore = 0, timerInterval, questionStartTime, userName = "";

    function confirmName() {
        userName = document.getElementById('user-name').value.trim();
        if (!userName) return alert("ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        document.getElementById('name-screen').style.display = 'none';
        loadCSV();
    }

    async function loadCSV() {
        try {
            const response = await fetch('words.csv');
            const data = await response.text();
            const rows = data.split('\n').slice(1);
            wordList = rows.map(row => {
                const [en, ja] = row.split(',');
                return { en: en?.trim(), ja: ja?.trim() };
            }).filter(item => item.en && item.ja);
            shuffleArray(wordList);
            startQuiz();
        } catch (e) {
            alert("words.csv„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éï„Ç°„Ç§„É´„ÅåÂêå„Åò„Éï„Ç©„É´„ÉÄ„Å´„ÅÇ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
        }
    }

    function startQuiz() {
        document.getElementById('quiz-area').style.display = 'block';
        document.getElementById('timer-container').style.display = 'block';
        showQuestion();
    }

    function showQuestion() {
        if (currentIndex >= MAX_QUESTIONS || currentIndex >= wordList.length) return showResult();
        const cur = wordList[currentIndex];
        document.getElementById('progress').innerText = `Á¨¨ ${currentIndex+1} / ${Math.min(MAX_QUESTIONS, wordList.length)} Âïè`;
        document.getElementById('word').innerText = cur.en;
        document.getElementById('feedback').innerText = "";
        const choices = createChoices(cur.ja);
        const choicesDiv = document.getElementById('choices');
        choicesDiv.innerHTML = "";
        choices.forEach(c => {
            const btn = document.createElement('button');
            btn.className = 'choice-btn'; btn.innerText = c;
            btn.onclick = () => checkAnswer(c, cur.ja);
            choicesDiv.appendChild(btn);
        });
        questionStartTime = Date.now();
        startTimer(cur.ja);
    }

    function startTimer(correct) {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            const elapsed = Date.now() - questionStartTime;
            document.getElementById('timer-bar').style.width = Math.max(0, 100 - (elapsed/TIME_LIMIT_MS*100)) + "%";
            if (elapsed >= TIME_LIMIT_MS) checkAnswer(null, correct);
        }, 30);
    }

    function checkAnswer(sel, cor) {
        clearInterval(timerInterval);
        const time = Date.now() - questionStartTime;
        document.querySelectorAll('.choice-btn').forEach(b => b.disabled = true);
        const feedback = document.getElementById('feedback');
        if (sel === cor) {
            totalScore += Math.max(0, 10000 - time);
            feedback.innerText = "„Äá Ê≠£Ëß£ÔºÅ";
            feedback.style.color = "#4cd137";
        } else {
            feedback.innerText = "√ó ‰∏çÊ≠£Ëß£";
            feedback.style.color = "#e84118";
        }
        currentIndex++;
        setTimeout(showQuestion, 1000);
    }

    async function showResult() {
    document.getElementById('quiz-area').style.display = 'none';
    document.getElementById('timer-container').style.display = 'none';
    document.getElementById('result-area').style.display = 'block';
    const score = Math.floor(totalScore);
    document.getElementById('final-points').innerText = score.toLocaleString();

    document.getElementById('msg').innerText = "„Çπ„Ç≥„Ç¢ÈÄÅ‰ø°‰∏≠...";
    
    try {
        // 1. „Çπ„Ç≥„Ç¢‰øùÂ≠ò
        const { error: insertError } = await _supabase.from('scores').insert([{ name: userName, score: score }]);
        if (insertError) throw insertError; // ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åü„Çâ„Åì„Åì„ÅßÊ≠¢„ÇÅ„Çã

        // 2. È†Ü‰ΩçÂèñÂæó
        const startOfDay = new Date(); startOfDay.setHours(0,0,0,0);
        const { count, error: selectError } = await _supabase
            .from('scores')
            .select('*', { count: 'exact', head: true })
            .gte('created_at', startOfDay.toISOString())
            .gt('score', score);
        
        if (selectError) throw selectError; // ÂèñÂæó„Å´Â§±Êïó„Åó„Åü„Çâ„Åì„Åì„ÅßÊ≠¢„ÇÅ„Çã

        document.getElementById('rank-val').innerText = (count + 1);
        document.getElementById('rank-container').style.display = 'block';
        document.getElementById('msg').innerText = "ÂêåÊúüÂÆå‰∫ÜÔºÅ";

    } catch (e) {
        console.error("„Ç®„É©„ÉºË©≥Á¥∞:", e);
        document.getElementById('msg').innerText = "ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
    }
}

    function createChoices(cor) {
        let opts = [cor];
        const others = wordList.filter(w => w.ja !== cor);
        shuffleArray(others);
        for(let i=0; i<3; i++) opts.push(others[i].ja);
        shuffleArray(opts);
        return opts;
    }

    function shuffleArray(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
    }
</script>